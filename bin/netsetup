#!/usr/bin/env perl
#~ use lib ($ENV{'HOME'} . '/Dropbox/Autoadmin1/lib');

use strict;
use warnings;
use Getopt::Std;
use Data::Dumper;
use NetSetup::Logger;

##########################################################
# глобальные переменные
##########################################################
#
my $exit_code = 0;
# режим выполнения команды
my $mode;
# уровень тишины
my $silence = 0;
# уровень дебага
my $logger_level = 'INFO';
my $net_setup_config_file = "/etc/netsetup.conf";
my $net_setup;
my @old_config_files;
my @new_config_files;
my $old_config;
my $new_config;

# опции командной строки
my $Usage =	"usage: $0 [-h] [-d 1-3] [-v] [-с] [update [all|template] | show [old|new|diff|] template]]\n" .
				"\n" .
				"decription:\n" .
				"\tnetwork configurator\n" .
				"\n" .
				"options:\n" .
				"\t-h\tthis page\n" .
				"\t-d\tdebug level [1-3]\n" .
				"\t-v\twithout verfication\n" .
				"\t-c\tconfig file for this program\n" .
				"";

my %argv;
my $args = 'vhd:';
getopts($args, \%argv);


# вывод help
if (defined($argv{'h'}) || !@ARGV || $ARGV[0] !~ m/^(update|show)$/) {
	print "$Usage";
	exit 1;
}
# уровень дебага
if (defined $argv{'d'} && $argv{'d'} <= 3) {
	$logger_level = "DEBUG" . $argv{'d'};
	$logger_level = 'DEBUG' if $logger_level eq 'DEBUG1';
}
# определение файла с конфигурацией программы
if(defined $argv{'c'} && $argv{'c'}) {
	$net_setup_config_file = $argv{'c'};
}


# инициализация логгера
my $logger = logger_init(STDERR => 1, LEVEL => $logger_level);

########################################################################
# НАЧАЛО
########################################################################
# подключение библиотки.
require NetSetup;
# проверка на чтение конфигурационного файла
if (!-r $net_setup_config_file) {
	$logger->fatal("can't open ${net_setup_config_file} for reading");
	exit 1;
}
# инициализация NetSetup
$net_setup = NetSetup->new($net_setup_config_file);
########################################################################
# получить старый конфиг
########################################################################
@old_config_files = $net_setup->find_in_tmp();
$old_config = $net_setup->get_config_obj(@old_config_files);
# пуст ли старый конфиг? если да, вывести информацию об этом
########################################################################
# получить новый конфиг
########################################################################
@new_config_files = $net_setup->find_newest_set();
$new_config = $net_setup->get_config_obj(@new_config_files);
# нового конфига не может не быть
if (!$new_config || $new_config->is_empty()) {
	$logger->fatal("new config hasn't been found");
	exit 1;
}
########################################################################
# сравнить конфиги
########################################################################
$new_config->compare_with_old($old_config);
########################################################################
# режим работы
########################################################################
$mode = shift;
########################################################################
# SHOW
########################################################################
# режим show без аргументов показывает текущие настройки (старый конфиг),
# а так же разницу с новым конфигом, если она есть
# 
# если передан аргумент diff - покажет разницу старого и нового конфигов
# без вывода неизменных частей
#
# если передан шаблон, то произведен поиск по шаблону и выведет те
# интерфейсы, в которых этот шаблон встречается
# 
if ($mode eq 'show') {
	# аргументов нет. значит нужно вывести старый конфиг полностью + разницу
	if (!@ARGV || $ARGV[0] eq 'old') {
		$logger->debug("show old");
		shift;
		print $old_config->str(@ARGV);
		print "--------------------------------\n";
		print "DIFFERENCE:\n";
		print "--------------------------------\n";
		print $new_config->get_diff(@ARGV);
	}
	# новый конфиг
	elsif ($ARGV[0] eq 'new') {
		$logger->debug("show new");
		shift;
		print $new_config->str(@ARGV);
	}
	# разница
	elsif ($ARGV[0] eq 'diff') {
		$logger->debug("show diff");
		shift;
		print $new_config->get_diff(@ARGV);
	}
	# если не совпадает, значит шаблон
	else {
		$logger->debug("show by template");
		print $old_config->str(@ARGV);
	}
}

my $ret = $net_setup->copy_to_tmp(@new_config_files);
if (!$ret) {
	$logger->error("An error has been occurred at the files copying");
	$exit_code = 1;
}

exit $exit_code;


